- name: Commit and push changes
  uses: actions/github-script@v6
  with:
    script: |
      const { execSync } = require('child_process');
      const fs = require('fs');
      
      // 配置 Git 用户
      execSync('git config --global user.name "GitHub Actions"');
      execSync('git config --global user.email "actions@users.noreply.github.com"');
      
      // 安全添加文件
      const filesToAdd = [];
      if (fs.existsSync('data/game_cards.json')) {
        filesToAdd.push('data/game_cards.json');
      }
      if (fs.existsSync('data/activity_cards.json')) {
        filesToAdd.push('data/activity_cards.json');
      }
      
      if (filesToAdd.length === 0) {
        console.log('没有需要添加的文件');
        return;
      }
      
      execSync(`git add ${filesToAdd.join(' ')}`);
      
      // 检查是否有更改
      const status = execSync('git status --porcelain').toString().trim();
      if (!status) {
        console.log('没有需要提交的更改');
        return;
      }
      
      // 提交更改
      const commitMessage = `自动更新数据: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`;
      execSync(`git commit -m "${commitMessage}"`);
      
      // 推送到 GitHub - 修复后的逻辑
      try {
        execSync('git push origin HEAD:${{ github.ref }}');
        console.log('推送成功');
      } catch (error) {
        console.error('推送失败:', error);
        
        // 获取分支名称（去掉 refs/heads/ 前缀）
        const branchRef = "${{ github.ref }}";
        const branchName = branchRef.replace('refs/heads/', '');
        
        console.log('尝试整合远程更改...');
        
        // 关键修复：使用变基(rebase)整合更改，保留本地提交
        execSync(`git pull origin ${branchName} --rebase`);
        
        // 重新推送（此时历史已线性化）
        try {
          execSync('git push origin HEAD:${{ github.ref }}');
          console.log('整合后推送成功');
        } catch (retryError) {
          console.error('二次推送失败，尝试强制推送:', retryError);
          
          // 仅在绝对必要时强制推送
          execSync(`git push origin HEAD:${branchName} --force`);
          console.log('强制推送成功');
        }
      }
